// è·å–ç¯å¢ƒå˜é‡
const githubToken = GITHUB_TOKEN;
const repo = REPO;
const branch = BRANCH;
const filePath = FILE_PATH;

// ç›‘å¬ fetch äº‹ä»¶
addEventListener('fetch', event => {
  event.respondWith(handleRequest(event.request));
});

// å¤„ç†è¯·æ±‚çš„å‡½æ•°
async function handleRequest(request) {
  const { pathname } = new URL(request.url);

  if (pathname === '/') {
    return handleRootRequest(); // è¿”å› HTML é¡µé¢
  } else if (pathname === '/upload' && request.method === 'POST') {
    return handleUploadRequest(request); // å¤„ç†æ–‡ä»¶ä¸Šä¼ è¯·æ±‚
  } else {
    return new Response('Not Found', { status: 404 });
  }
}

// å¤„ç†æ ¹è·¯å¾„è¯·æ±‚çš„å‡½æ•°ï¼Œè¿”å› HTML é¡µé¢
function handleRootRequest() {
  const html = `
  <!DOCTYPE html>
  <html lang="zh-CN"
  <head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0, viewport-fit=cover">
      <meta name="description" content="GitHubå›¾åºŠ-åŸºäºCloudflare Workers">
      <meta name="keywords" content="GitHubå›¾åºŠ,Workerså›¾åºŠ, Cloudflare, Workers,GitHub, å›¾åºŠ">
      <title>GitHubå›¾åºŠ</title>
      <link rel="icon" href="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBzdGFuZGFsb25lPSJubyI/Pgo8IURPQ1RZUEUgc3ZnIFBVQkxJQyAiLS8vVzNDLy9EVEQgU1ZHIDIwMDEwOTA0Ly9FTiIKICJodHRwOi8vd3d3LnczLm9yZy9UUi8yMDAxL1JFQy1TVkctMjAwMTA5MDQvRFREL3N2ZzEwLmR0ZCI+CjxzdmcgdmVyc2lvbj0iMS4wIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciCiB3aWR0aD0iNDguMDAwMDAwcHQiIGhlaWdodD0iNDguMDAwMDAwcHQiIHZpZXdCb3g9IjAgMCA0OC4wMDAwMDAgNDguMDAwMDAwIgogcHJlc2VydmVBc3BlY3RSYXRpbz0ieE1pZFlNaWQgbWVldCI+Cgo8ZyB0cmFuc2Zvcm09InRyYW5zbGF0ZSgwLjAwMDAwMCw0OC4wMDAwMDApIHNjYWxlKDAuMTAwMDAwLC0wLjEwMDAwMCkiCmZpbGw9IiMwMDAwMDAiIHN0cm9rZT0ibm9uZSI+CjxwYXRoIGQ9Ik04MCA0MDUgbDAgLTM1IDY1IDAgNjUgMCAwIC0xNzUgMCAtMTc1IDM1IDAgMzUgMCAwIDE3NSAwIDE3NSA2NSAwCjY1IDAgMCAzNSAwIDM1IC0xNjUgMCAtMTY1IDAgMCAtMzV6Ii8+CjwvZz4KPC9zdmc+Cg==" type="image/x-icon">
      <!-- Twitter Bootstrap CSS -->
      <link href="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/twitter-bootstrap/4.6.1/css/bootstrap.min.css" type="text/css" rel="stylesheet" />
      <!-- Bootstrap FileInput CSS -->
      <link href="https://lf26-cdn-tos.bytecdntp.com/cdn/expire-1-M/bootstrap-fileinput/5.2.7/css/fileinput.min.css" type="text/css" rel="stylesheet" />
      <!-- Toastr CSS -->
      <link href="https://lf26-cdn-tos.bytecdntp.com/cdn/expire-1-M/toastr.js/2.1.4/toastr.min.css" type="text/css" rel="stylesheet" />
      <!-- jQuery -->
      <script src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/jquery/3.6.0/jquery.min.js" type="application/javascript"></script>
      <!-- Bootstrap FileInput JS -->
      <script src="https://lf26-cdn-tos.bytecdntp.com/cdn/expire-1-M/bootstrap-fileinput/5.2.7/js/fileinput.min.js" type="application/javascript"></script>
      <!-- Bootstrap FileInput Chinese Locale JS -->
      <script src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/bootstrap-fileinput/5.2.7/js/locales/zh.min.js" type="application/javascript"></script>
      <!-- Toastr JS -->
      <script src="https://lf9-cdn-tos.bytecdntp.com/cdn/expire-1-M/toastr.js/2.1.4/toastr.min.js" type="application/javascript"></script> 
      <style>
      @import url('https://fonts.googleapis.com/css2?family=Long+Cang&display=swap');
      
      .title {
          font-family: "Long Cang", cursive;
          font-weight: 400;
          font-style: normal;
          font-size: 2em; /* è°ƒæ•´å­—ä½“å¤§å° */
          text-align: center;
          margin-top: 20px; /* è°ƒæ•´è·ç¦»é¡¶éƒ¨çš„è·ç¦» */
          text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5); /* æ·»åŠ é˜´å½±æ•ˆæœ */
      }
      
      /* æ—¥é—´æ¨¡å¼å’Œå¤œé—´æ¨¡å¼çš„æ ·å¼ */
      .day-mode {
          background-color: #ffffff;
          color: #000000;
      }
  
      .night-mode {
          background-color: #2c2c2c;
          color: #f5f5f5;
      }
  
      /* æŒ‰é’®æ ·å¼ */
      .mode-toggle {
          position: fixed;
          top: 10px;
          right: 10px;
          background-color: transparent;
          border: none;
          font-size: 1.5em;
          cursor: pointer;
          z-index: 1000;
      }
  
      /* åº”ç”¨åˆ°æ•´ä¸ªé¡µé¢çš„èƒŒæ™¯å’Œæ–‡å­—é¢œè‰² */
      body.night-mode {
          background-color: #2c2c2c;
          color: #f5f5f5;
      }
  
      body.day-mode {
          background-color: #ffffff;
          color: #000000;
      }
  
      /* å¼ºåˆ¶è¦†ç›–é»˜è®¤æ ·å¼ï¼Œç¡®ä¿åœ¨ä¸¤ç§æ¨¡å¼ä¸‹éƒ½èƒ½åº”ç”¨ */
      .card,
      .card-body,
      .form-group,
      textarea,
      select,
      input[type="file"],
      button {
          background-color: inherit;
          color: inherit;
          border-color: inherit;
      }
  
      .card {
          box-shadow: none;
          border: none;
      }
      /* ä¸ºå…¶ä»–å…ƒç´ å®šä¹‰æ ·å¼ */
.card, .card-body, .form-group, textarea, select, input[type="file"], button {
    /* é»˜è®¤æ ·å¼ */
    background-color: inherit;
    color: inherit;
    border-color: inherit;
}

/* ç‰¹å®šå…ƒç´ åœ¨å¤œé—´æ¨¡å¼ä¸‹çš„æ ·å¼ */
body.night-mode .card,
body.night-mode .card-body,
body.night-mode .form-group,
body.night-mode textarea,
body.night-mode select,
body.night-mode input[type="file"],
body.night-mode button {
    background-color: #333333;
    color: #ffffff;
    border-color: #555555;
}
:root {
  --background-color: #ffffff;
  --text-color: #000000;
  --border-color: #cccccc;
}

body.day-mode {
  --background-color: #ffffff;
  --text-color: #000000;
  --border-color: #cccccc;
}

body.night-mode {
  --background-color: #2c2c2c;
  --text-color: #f5f5f5;
  --border-color: #555555;
}

.card, .card-body, .form-group, textarea, select, input[type="file"], button {
  background-color: var(--background-color);
  color: var(--text-color);
  border-color: var(--border-color);
}

#fileLink {
  background-color: var(--background-color);
  color: var(--text-color);
  border-color: var(--border-color);
}

      </style>
  </head>
  <body class="day-mode">
      <!-- æ¨¡å¼åˆ‡æ¢æŒ‰é’® -->
      <button class="mode-toggle" id="modeToggle">ğŸŒ™</button>
      <div class="card">
          <div class="title">Hello GitHubå›¾åºŠ</div>
          <div class="card-body">
              <!-- è¡¨å• -->
              <form id="uploadForm" action="/upload" method="post" enctype="multipart/form-data">
                  <!-- æ¥å£é€‰æ‹©ä¸‹æ‹‰èœå• -->
                  <div class="form-group mb-3">
                      <select class="custom-select" id="interfaceSelector" name="interface">
                          <option value="tg">GitHub</option>
                      </select>
                  </div>
                  <!-- æ–‡ä»¶é€‰æ‹© -->
                  <div class="form-group mb-3">
                      <input id="fileInput" name="file" type="file" class="form-control-file" data-browse-on-zone-click="true">
                  </div>            
                  <!-- æ·»åŠ æŒ‰é’®ç»„ -->
                  <div class="form-group mb-3" style="display: none;"> <!-- åˆå§‹éšè— -->
                      <button type="button" class="btn btn-light mr-2" id="urlBtn">URL</button>
                      <button type="button" class="btn btn-light mr-2" id="bbcodeBtn">BBCode</button>
                      <button type="button" class="btn btn-light" id="markdownBtn">Markdown</button>
                  </div>
                  <!-- æ–‡ä»¶é“¾æ¥æ–‡æœ¬æ¡† -->
                  <div class="form-group mb-3" style="display: none;"> <!-- åˆå§‹éšè— -->
                      <textarea class="form-control" id="fileLink" readonly></textarea>
                  </div>
                  <!-- ä¸Šä¼ ä¸­çš„æç¤º -->
                  <div id="uploadingText" style="display: none; text-align: center;">æ–‡ä»¶ä¸Šä¼ ä¸­...</div>
                  <!-- å‹ç¼©ä¸­çš„æç¤º -->
                  <div id="compressingText" style="display: none; text-align: center;">å›¾ç‰‡å‹ç¼©ä¸­...</div>
              </form>
          </div>
          <p style="font-size: 14px; text-align: center; position: fixed; bottom: 0; width: 100%; padding: 10px 0; solid #ccc;">
              ä¸€å¶çŸ¥ç§‹-é­æ— ç¾¡ GitHub - <a href="https://github.com/2091k/GitHub-image-hosting" target="_blank" rel="noopener noreferrer" style="color: #007bff; text-decoration: none;">2091k/GitHub-image-hosting</a>
          </p>
      </div> 
<script>
$(document).ready(function() {
  // æ£€æŸ¥æœ¬åœ°å­˜å‚¨ä¸­æ˜¯å¦æœ‰æ¨¡å¼é€‰æ‹©
  if (localStorage.getItem('mode') === 'night') {
      $('body').addClass('night-mode').removeClass('day-mode');
      $('#modeToggle').text('ğŸŒ™');
  } else {
      $('body').addClass('day-mode').removeClass('night-mode');
      $('#modeToggle').text('ğŸŒ');
  }
  // æ¨¡å¼åˆ‡æ¢é€»è¾‘
  $('#modeToggle').on('click', function() {
      $('body').toggleClass('night-mode day-mode');

      // åˆ‡æ¢æŒ‰é’®å›¾æ ‡
      if ($('body').hasClass('night-mode')) {
          $(this).text('ğŸŒ™');
          localStorage.setItem('mode', 'night');
      } else {
          $(this).text('ğŸŒ');
          localStorage.setItem('mode', 'day');
      }

      // å¼ºåˆ¶æ›´æ–°æ‰€æœ‰ç›¸å…³å…ƒç´ çš„æ ·å¼
      $('.card, .card-body, .form-group, textarea, select, input[type="file"], button').css({
          'background-color': $('body').css('background-color'),
          'color': $('body').css('color'),
          'border-color': $('body').css('border-color')
        });
  });

  // åˆå§‹åŒ–æ–‡ä»¶ä¸Šä¼  
  initFileInput();
  
  // æ–‡ä»¶ä¸Šä¼ åˆå§‹åŒ–å‡½æ•°
  function initFileInput() {
    $("#fileInput").fileinput({
      theme: 'fa',
      language: 'zh',
      dropZoneEnabled: true,
      browseOnZoneClick: true,
      dropZoneTitle: "æ‹–æ‹½æˆ–ç²˜è´´æ–‡ä»¶åˆ°è¿™é‡Œ...",
      dropZoneClickTitle: "",
      browseClass: "btn btn-light",
      uploadClass: "btn btn-light",
      removeClass: "btn btn-light",
      showUpload: false,
      layoutTemplates: {
        actionZoom: '',
      },
    }).on('filebatchselected', handleFileSelection)
      .on('fileclear', handleFileClear);
  }

  // é…ç½®æ¥å£ä¿¡æ¯
  const interfaceConfig = {
    tg: {
      acceptTypes: 'image/gif,image/jpeg,image/jpg,image/png,video/mp4',
      gifAndVideoMaxSize: 5 * 1024 * 1024, // GIF å’Œè§†é¢‘æ–‡ä»¶çš„æœ€å¤§å¤§å°ä¸º 5MB
      otherMaxSize: 5 * 1024 * 1024, // é GIF å’Œè§†é¢‘æ–‡ä»¶çš„æœ€å¤§å¤§å°ä¸º 5MB
      compressImage: false //é»˜è®¤å¼€å¯å‹ç¼©
    },
    // æ·»åŠ å…¶ä»–æ¥å£çš„é…ç½®ä¿¡æ¯
  };
  
  // å¤„ç†æ¥å£é€‰æ‹©å™¨å˜æ›´äº‹ä»¶  
  $('#interfaceSelector').change(function() {
    const selectedInterface = $(this).val();
    const interfaceInfo = interfaceConfig[selectedInterface];
    
    if (interfaceInfo) {
      $('#fileInput').attr('accept', interfaceInfo.acceptTypes);
    }
  }).trigger('change');
  
  // å¤„ç†æ–‡ä»¶é€‰æ‹©äº‹ä»¶  
  async function handleFileSelection() {
      const file = $('#fileInput')[0].files[0];
  
      if (file) {
          await uploadFile(file);
      }
  }

  // å¤„ç†ä¸Šä¼ æ–‡ä»¶å‡½æ•°
  async function uploadFile(file) {
      try {
          const selectedInterface = $('#interfaceSelector').val();
          const interfaceInfo = interfaceConfig[selectedInterface];
          
          if (!interfaceInfo) {
            console.error('æœªæ‰¾åˆ°æ¥å£é…ç½®ä¿¡æ¯');
            return;
          }
  
          if (['image/gif', 'video/mp4'].includes(file.type)) {
              if (file.size > interfaceInfo.gifAndVideoMaxSize) {
                  toastr.error('æ–‡ä»¶å¿…é¡»â‰¤' + interfaceInfo.gifAndVideoMaxSize / (1024 * 1024) + 'MB');
                  return;
              }
              // ä¸å‹ç¼©ï¼Œç›´æ¥ä¸Šä¼ åŸæ–‡ä»¶
          } else {
              if (interfaceInfo.compressImage === true) {
                  const compressedFile = await compressImage(file);
                  file = compressedFile;
              } else if (interfaceInfo.compressImage === false) {
                  if (file.size > interfaceInfo.otherMaxSize) {
                      toastr.error('æ–‡ä»¶å¿…é¡»â‰¤' + interfaceInfo.otherMaxSize / (1024 * 1024) + 'MB');
                      return;
                  }
                  // ä¸å‹ç¼©ï¼Œç›´æ¥ä¸Šä¼ åŸæ–‡ä»¶
              }
          }
  
          $('#uploadingText').show();
          const formData = new FormData($('#uploadForm')[0]);
          formData.set('file', file, file.name);
          const uploadResponse = await fetch('/upload', { method: 'POST', body: formData });
          originalImageURL = await handleUploadResponse(uploadResponse);
          $('#fileLink').val(originalImageURL);
          $('.form-group').show();
          adjustTextareaHeight($('#fileLink')[0]);
      } catch (error) {
          console.error('ä¸Šä¼ æ–‡ä»¶æ—¶å‡ºç°é”™è¯¯:', error);
          $('#fileLink').val('æ–‡ä»¶ä¸Šä¼ å¤±è´¥ï¼');
      } finally {
          $('#uploadingText').hide();
      }
  }

  // å¤„ç†ä¸Šä¼ å“åº”å‡½æ•°
  async function handleUploadResponse(response) {
    if (response.ok) {
      const result = await response.json();
      return result.data;
    } else {
      return 'æ–‡ä»¶ä¸Šä¼ å¤±è´¥ï¼';
    }
  }

  // ç›‘å¬ç²˜è´´äº‹ä»¶
  $(document).on('paste', function(event) {
      // è·å–ç²˜è´´æ¿ä¸­çš„å†…å®¹
      const clipboardData = event.originalEvent.clipboardData;
      if (clipboardData && clipboardData.items) {
          // éå†ç²˜è´´æ¿ä¸­çš„é¡¹
          for (let i = 0; i < clipboardData.items.length; i++) {
              const item = clipboardData.items[i];
              // å¦‚æœæ˜¯æ–‡ä»¶ç±»å‹
              if (item.kind === 'file') {
                  const pasteFile = item.getAsFile();
                  // ä¸Šä¼ ç²˜è´´çš„æ–‡ä»¶
                  uploadFile(pasteFile);
                  break; // å¤„ç†å®Œç¬¬ä¸€ä¸ªæ–‡ä»¶å³å¯
              }
          }
      }
  });

  //å¤„ç†å›¾ç‰‡å‹ç¼©äº‹ä»¶
  async function compressImage(file, quality = 0.5, maxResolution = 20000000) {
    $('#compressingText').show();
  
    return new Promise((resolve) => {
      const image = new Image();
      image.onload = () => {
        const width = image.width;
        const height = image.height;  
        const resolution = width * height;  
        let scale = 1;
        if (resolution > maxResolution) {
          scale = Math.sqrt(maxResolution / resolution);
        }  
        const targetWidth = Math.round(width * scale);
        const targetHeight = Math.round(height * scale);  
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');  
        canvas.width = targetWidth;
        canvas.height = targetHeight;
        ctx.drawImage(image, 0, 0, targetWidth, targetHeight); 
        canvas.toBlob((blob) => {
          const compressedFile = new File([blob], file.name, { type: 'image/jpeg' });
          $('#compressingText').hide();
          resolve(compressedFile);
        }, 'image/jpeg', quality);
      };  
      const reader = new FileReader();
      reader.onload = (event) => {
        image.src = event.target.result;
      };
      reader.readAsDataURL(file);
    });
  }
  
  // å¤„ç†æŒ‰é’®ç‚¹å‡»äº‹ä»¶ 
  $('#urlBtn, #bbcodeBtn, #markdownBtn').on('click', function() {
    const fileLink = originalImageURL.trim();
    if (fileLink !== '') {
      let formattedLink;
      switch ($(this).attr('id')) {
        case 'urlBtn':
          formattedLink = fileLink;
          break;
        case 'bbcodeBtn':
          formattedLink = '[img]' + fileLink + '[/img]';
          break;
        case 'markdownBtn':
          formattedLink = '![image](' + fileLink + ')';
          break;
        default:
          formattedLink = fileLink;
      }
      $('#fileLink').val(formattedLink);
      adjustTextareaHeight($('#fileLink')[0]);
      copyToClipboardWithToastr(formattedLink);
    }
  });
  
  // å¤„ç†ç§»é™¤æŒ‰é’®ç‚¹å‡»äº‹ä»¶ 
  function handleFileClear(event) {
    $('#fileLink').val('');
    adjustTextareaHeight($('#fileLink')[0]);
    hideButtonsAndTextarea();
  }
  
  // è‡ªåŠ¨è°ƒæ•´æ–‡æœ¬æ¡†é«˜åº¦å‡½æ•°
  function adjustTextareaHeight(textarea) {
    textarea.style.height = '1px';
    textarea.style.height = (textarea.scrollHeight) + 'px';
  }
  
  // å¤åˆ¶æ–‡æœ¬åˆ°å‰ªè´´æ¿ï¼Œå¹¶æ˜¾ç¤º toastr æç¤ºæ¡† 
  function copyToClipboardWithToastr(text) {
    const input = document.createElement('input');
    input.setAttribute('value', text);
    document.body.appendChild(input);
    input.select();
    document.execCommand('copy');
    document.body.removeChild(input);
    toastr.success('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', '', { timeOut: 300 });
  }
  
  // éšè—æŒ‰é’®å’Œæ–‡æœ¬æ¡†
  function hideButtonsAndTextarea() {
    $('#urlBtn, #bbcodeBtn, #markdownBtn, #fileLink').parent('.form-group').hide();
  }
  
});

</script>

</body>
</html>
    `;
    return new Response(html, { headers: { 'Content-Type': 'text/html;charset=UTF-8' } });
  }
  
// å¤„ç†ä¸Šä¼ è¯·æ±‚çš„å‡½æ•°
async function handleUploadRequest(request) {
  try {
    const formData = await request.formData();
    const file = formData.get('file');

    if (!file) {
      throw new Error('Missing file');
    }

    const originalFileName = file.name;
    const fileExtension = originalFileName.split('.').pop();

    // è·å–å½“å‰æ—¶é—´å¹¶è½¬æ¢ä¸ºåŒ—äº¬æ—¶é—´ (UTC+8)
    const now = new Date();
    const utcOffset = 8 * 60; // åŒ—äº¬æ—¶é—´ä¸º UTC+8
    now.setMinutes(now.getMinutes() + utcOffset);
    const formattedDate = now.toISOString()
      .replace(/T/, '-')
      .replace(/\..+/, '')
      .replace(/:/g, '-');
    const fileName = `${formattedDate}.${fileExtension}`;

    // 1. æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å·²ç»å­˜åœ¨
    const checkUrl = `https://api.github.com/repos/${repo}/contents/${filePath}${fileName}?ref=${branch}`;
    const checkResponse = await fetch(checkUrl, {
      method: 'GET',
      headers: {
        'Authorization': `Bearer ${githubToken}`,
        'Accept': 'application/vnd.github.v3+json',
        'User-Agent': 'Cloudflare Worker'
      }
    });

    // 2. å‡†å¤‡ä¸Šä¼ æ–‡ä»¶
    const fileStream = file.stream();
    const reader = fileStream.getReader();
    let fileContent = '';
    let done = false;

    // Convert file content to base64 in chunks
    while (!done) {
      const { value, done: readerDone } = await reader.read();
      done = readerDone;
      if (value) {
        fileContent += String.fromCharCode(...new Uint8Array(value));
      }
    }

    const base64Content = btoa(fileContent);
    const uploadUrl = `https://api.github.com/repos/${repo}/contents/${filePath}${fileName}`;

    const uploadData = {
      message: `ä¸Šä¼ å›¾ç‰‡: ${fileName}`,
      content: base64Content,
      branch: branch
    };

    const uploadResponse = await fetch(uploadUrl, {
      method: 'PUT',
      headers: {
        'Authorization': `Bearer ${githubToken}`,
        'Content-Type': 'application/json',
        'Accept': 'application/vnd.github.v3+json',
        'User-Agent': 'Cloudflare Worker'
      },
      body: JSON.stringify(uploadData)
    });

    const responseText = await uploadResponse.text();
    const jsonResponse = JSON.parse(responseText);

    if (uploadResponse.ok) {
      // ä½¿ç”¨ jsDelivr URL ä½œä¸ºå›¾ç‰‡é“¾æ¥
      const imageUrl = `ä½ çš„CloudFlare cdn åŸŸå/https://raw.githubusercontent.com/${repo}/${branch}/${filePath}${fileName}`;
      return new Response(JSON.stringify({ data: imageUrl }), {
        status: 201,
        headers: { 'Content-Type': 'application/json' }
      });
    } else {
      console.error('GitHub upload failed:', responseText);
      return new Response(JSON.stringify({ error: 'GitHub upload failed', details: responseText }), {
        status: 500,
        headers: { 'Content-Type': 'application/json' }
      });
    }
  } catch (error) {
    console.error('Internal Server Error:', error.message);
    return new Response(JSON.stringify({ error: 'Internal Server Error', message: error.message }), {
      status: 500,
      headers: { 'Content-Type': 'application/json' }
    });
  }
}
